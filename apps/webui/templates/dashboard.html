{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block bar %}
{% if zones %}
<h2>Filter</h2>
<p id="zones">
<a href="?">All (Reset)</a><br />
{% for zone in zones %}
<a href="?filter_zone={{ zone.id }}" longitude="{{ zone.lon }}" latitude="{{ zone.lat }}">{{ zone.name }}</a><br />
{% endfor %}
</p>
<h2>Drill down</h2>
<p>
{% for zone in zones %}
<a href="/zone/{{ zone.id }}/">{{ zone.name }}</a><br />
{% endfor %}
</p>
{% endif %}
{% if facilities %}
<h2>Drill down</h2>
<p>
{% for facility in facilities %}
<a href="/facility/{{ facility.id }}/">{{ facility.name }}</a><br />
{% endfor %}
</p>
{% endif %}
{% endblock %}

{% block content %}
<table>
    <thead>
    <tr>
        <th><abbr title="Last Calendar Month">Last month</abbr></th>
        <th><abbr title="# of unique SMS reports">Reports</abbr></th>
        <th><abbr title="% moderate malnutrition">Moderate</abbr></th>
        <th><abbr title="% severe malnutrition">Severe</abbr></th>
        <th><abbr title="% stunting">Stunting</abbr></th>
        <th><abbr title="% oedema">Oedema</abbr></th>
        <th><abbr title="% diarrhea">Diarrhea</abbr></th>
    </tr>
    </thead>
    <tbody>
        {% for row in lastmonth %}
        <tr>
            {% for entry in row %}    
                {% if forloop.first %}
                <td>{{ entry|title }}</td>
                {% else %}
                <td>{{ entry.message|stringformat:".2f" }}</td>
                <td>{{ entry.moderate|stringformat:".2f" }}</td>
                <td>{{ entry.severe|stringformat:".2f" }}</td>
                <td>{{ entry.stunting|stringformat:".2f" }}</td>
                <td>{{ entry.oedema|stringformat:".2f" }}</td>
                <td>{{ entry.diarrhea|stringformat:".2f" }}</td>
                {% endif %}
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Unique SMS Reports</h2>
{{ message.javascript|safe }}
<p><a href="/?export=message">Export graph data</a></p>

<h2>% Severe Malnutrition</h2>
{{ severe.javascript|safe }}
<p><a href="/?export=severe">Export graph data</a></p>

<h2>% Moderate Malnutrition</h2>
{{ moderate.javascript|safe }}
<p><a href="/?export=moderate">Export graph data</a></p>

<h2>% Stunting</h2>
{{ stunting.javascript|safe }}
<p><a href="/?export=stunting">Export graph data</a></p>

<h2>% Oedema</h2>
{{ oedema.javascript|safe }}
<p><a href="/?export=oedema">Export graph data</a></p>

<h2>% Diarrhea</h2>
{{ diarrhea.javascript|safe }}
<p><a href="/?export=diarrhea">Export graph data</a></p> 

<h2>Average MUAC</h2>
{{ muac.javascript|safe }}
<p><a href="/?export=muac">Export graph data</a></p>

<h2>Average Height</h2>
{{ height.javascript|safe }}
<p><a href="/?export=height">Export graph data</a></p>

<h2>Average Weight</h2>
{{ weight.javascript|safe }}
<p><a href="/?export=weight">Export graph data</a></p>

<p id="map" class="span-20" style="height: 400px" />
<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key={{ settings.GOOGLE_MAPS_API_KEY }}" type="text/javascript"></script>
<script type="text/javascript">
var INITIAL_LAT = -13.464422;
var INITIAL_LON = 34.321289;
var map = null;
function initialize() {
    var elem = document.getElementById("map");
    if (!elem) {
        return;
    }
    map = new GMap2(elem);
    map.setCenter(new GLatLng(INITIAL_LAT, INITIAL_LON), 6);
    map.addControl(new GLargeMapControl());
};
initialize();
$(document).ready(function(){
    $("#zones a").each(function() {
        var a = jQuery(this);
        var longitude = a.attr("longitude");
        var latitude = a.attr("latitude");
        if ((latitude != 'None') && (longitude != 'None')) {
            var latlng = new GLatLng(latitude, longitude);
            var marker = new GMarker(latlng);
            map.addOverlay(marker);
            GEvent.addListener(marker, "click", function() {
              marker.openInfoWindowHtml('<a href="' + a.attr("href") + '">' + a.text() + '</a>');
            });
        };
    });
});
</script>
{% endblock %}
